---
{"dg-publish":true,"permalink":"/c1/lottery-project//","dgPassFrontmatter":true}
---


# 00.传统彩票与区块链彩票的对比
**传统彩票**
- 彩票会跑路
- 存在贪污腐败现象
**区块链彩票*
- 所有逻辑公开透明。因为所有代码都要上链，代码公开时需要verify。否则别人不会使用。
- 没有办法进行暗箱操作，不存在跑路。

# 01.区块链彩票业务分析
## 1.1 彩票规则
- 全民参与（play)
- 每一注只能投一个eth（可修改）
- 每个人可以投注多次
- 仅管理员定时开奖（kaijiang)
- 仅管理员可以退款（管理员到时间没有按时开奖，可以执行退奖）（tuijiang）

<div class="transclusion internal-embed is-loaded"><div class="markdown-embed">

<div class="markdown-embed-title">

# 800

</div>





==⚠  Switch to EXCALIDRAW VIEW in the MORE OPTIONS menu of this document. ⚠== You can decompress Drawing data with the command palette: 'Decompress current Excalidraw file'. For more info check in plugin settings under 'Saving'


# Excalidraw Data

## Text Elements
1.最初状态 
2.彩民参与 
3.管理员开奖：收取1%作手续费
 
4.管理员退款 
5.本期结束 
## Embedded Files
9edf35d75ffa494519b279ee26c001b630cdf283: [[Pasted Image 20250807083219_595.png]]

82ca73b4ac9183d663c6fc149a322e1aeeddb71e: [[Pasted Image 20250807083251_800.png]]

7ccb2910aab2bace1bc36c77749cd2eb94ae2a78: [[Pasted Image 20250807083356_091.png]]

ae35b692b6f874b29929382a0e4544ba7dab53a9: [[Pasted Image 20250807083416_929.png]]

1e07147c464cd135d8762b4db106ea6bae8693f7: [[Pasted Image 20250807083437_514.png]]



</div></div>


## 1.2 合约分析

### 属性分析

| 状态变量    | 类型         | 作用         |
| ------- | ---------- | ---------- |
| manager | address    | 创建彩票合约的地址  |
| players | address\[] | 所有的彩民地址的集合 |
| winner  | address    | 中奖人地址      |
| round   | uint       | 彩票期数       |
### 方法分析——核心方法

| 合约方法     | 作用   | 备注       |
| -------- | ---- | -------- |
| play     | 投注彩票 | 人人皆可参与   |
| kaijiang | 开奖   | 仅管理员可以操作 |
| tuijiang | 退款   | 仅管理员可以操作 |
### 方法分析——辅助方法

| 合约方法       | 作用           | 备注         |
| ---------- | ------------ | ---------- |
| getAmount  | 获取奖金池金额      |            |
| getManager | 返回管理员地址      |            |
| getRound   | 返回当前期数       | 开奖、退奖后加1   |
| getWinner  | 返回本期中奖人地址    | address    |
| getPlayers | 返回参与的彩民的地址集合 | address\[] |
## 1.3合约编写

[[C1=收集箱/lottery-project/附件2：编写合约时使用到的语法知识点\|附件2：编写合约时使用到的语法知识点]]
### 构造函数

编写基本框架、状态变量，添加构造函数，设置管理员

```sol
pragma solidity ^0.8.0;

contract Lottery{
	//管理员地址
	address public manager;
	//中奖彩民
	address public winner;
	//所有参与彩民
	address[] public players;
	//第几期彩票
	uint public round;

	constructor() {
		//设置管理员
		manager = msg.sender;
	}
}
```

### 参与彩票下注（play)

```
//彩民投注函数
function play() public payable{
	//每次投注1ether，可以多次投注
	require(msg.value == 1 ether);
	players.push(msg.sender);
}
```

备注：
1. 合约默认单位为wei，需要用ether指定
2. payable关键字必须添加
3. msg.value全局变量用于接收交易中的value字段
4. 数组添加成员用push

### 开奖函数

```
//开奖函数，仅管理员可以执行
function draw() public onlyOwner{
	require(players.length >0 , "no enough players participate in this term");
	
	uint256 bigInt = unint256(keccak256(abi.encodePacked(
		block.difficulty,
		block.timestamp,     //用于获取当前时间
		players.length
	)))

	uint256 index = bigInt % players.length;
	winner = players[index];
	winnder.transfer(address(this).balance);
	//本期结束后，期数加1
	round++;
	//清空所有人
	delete players;
}
```

备注：
1. onlyOwner是一个修饰器
2. 随机中奖需要一个随机的索引值，我们使用难度值，当前时间，参与人数作为种子生成一个大的数字生成索引。参考语法知识中的`ABI`,`HASH`这两个知识点
3. 开奖前验证有效性，无人参与则不开奖
4. 本轮结束后round++，进入下一轮
5. 删除参与所有人，delete只是删除元素，不会删除players

### 修饰器

```
//仅限管理员可以执行函数(draw, drawback函数)
modifier onlyOwner{
	require(manage == msg.sender);
	_; 
}
```

备注：
1. `_`：占位符，告诉solidity被修饰的代码在这里执行

### 退款函数

遍历数组，逐一转账，清除账户数组。
```
//退款函数，仅管理员可以执行
function drawback() public onlyOwner{
	require(players.length > 0)；
	for (uint256 i=0;i<players.length;i++){
		players[i].transfer(1 ether);	
	}
	//本期结束后，期数加1
	round++;
	//清除所有人
	delete players;
}
```

### 辅助函数

```
//返回参与人数数组
function getPlayers() public view returns(address[]){
	return players;
}

//返回当前奖金池金额
function getAmount() public view returns(uint256){
	return address(this).balance;
}

//返回管理员地址
function getManager() public view returns(address){
	return manager;
}

//返回当前期数
function getRound() public view returns(uint){
	return round;
}

//返回中奖者
function getWinner() public view returns(address){
	return winner;
}

//返回当前彩民人数
function getPlayerCount() public view returns(uint256){
	return player.length;
}
```

### 整体合约代码

![[附件3：整体合约代码.sol]]


# 02.环境准备——彩票前台调用模块

## 2.1 react环境准备

使用react脚手架，安装命令如下
```
npm install -g create-react-app
```

创建空项目
```
create-react-app lottery-react
```

进入到lottery-react目录，启动项目
```
npm run start 
//程序会⾃动跳转到⻚⾯:http://localhost:3000
```

界面组件库，[官方操作手册](https://react.semantic-ui.com/)
```
npm install --save semantic-ui-react
```

配套样式库有两种方式
一、下载样式包，如下命令
```
npm install --save semantic-ui-css
```
二、直接在public/index.html中添加在线样式(暂不考虑)
```
<link rel="stylesheet" href=
```

安装ether模块
```
npm install --save ethers
```

清理工程环境
1. 进入src目录，保留App.js和index.js，删除掉其他文件
2. 删掉App.js和index.js中对删除文件的依赖代码
3. 删掉App.js中render函数渲染的内容
最终效果
App.js
![image.png](https://dk-obsidian-1358400187.cos.ap-guangzhou.myqcloud.com/obsidian/202508071609617.png)

index.js
![image.png](https://dk-obsidian-1358400187.cos.ap-guangzhou.myqcloud.com/obsidian/202508071609486.png)

最后运行下面代码在`lottery-react`目录下
```
npm start
```

效果
![image.png](https://dk-obsidian-1358400187.cos.ap-guangzhou.myqcloud.com/obsidian/202508071610442.png)

# 03.数据交互
## 3.1 目录结构

在src目录创建如下目录和文件
![image.png](https://dk-obsidian-1358400187.cos.ap-guangzhou.myqcloud.com/obsidian/202508071619474.png)


## 3.2 初始化ethers

进入InitWeb3.js文件，添加如下代码
```
import { BrowserProvider, JsonRpcProvider } from "ethers";

let provider;

  

if (typeof window.ethereum !== 'undefined') {

  provider = new BrowserProvider(window.ethereum);

  provider.send("eth_requestAccounts", []).then(() => {

    console.log("MetaMask账户已授权");

  });

  console.log("Injected ethers provider found!");

} else {

  provider = new JsonRpcProvider("http://localhost:7545");

  console.log("Local ethers provider found!");

}

  
export default provider;
```

## 3.3测试ethers

调整index.js中的代码
![image.png](https://dk-obsidian-1358400187.cos.ap-guangzhou.myqcloud.com/obsidian/202508071634070.png)

我们可以在浏览器控制台，按f12查看结果
![image.png](https://dk-obsidian-1358400187.cos.ap-guangzhou.myqcloud.com/obsidian/202508071635145.png)
